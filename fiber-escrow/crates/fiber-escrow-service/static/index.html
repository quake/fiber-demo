<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiber Escrow Demo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-selector label {
            font-size: 0.9rem;
            color: #888;
        }
        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #3a7bd5;
            background: #1a1a2e;
            color: #fff;
            cursor: pointer;
        }
        .balance {
            padding: 8px 16px;
            background: rgba(0,210,255,0.1);
            border-radius: 8px;
            font-weight: bold;
            color: #00d2ff;
        }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px 8px 0 0;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab:hover {
            background: rgba(255,255,255,0.1);
        }
        .tab.active {
            background: rgba(58,123,213,0.3);
            color: #fff;
        }
        .tab-content {
            display: none;
            background: rgba(255,255,255,0.03);
            border-radius: 0 12px 12px 12px;
            padding: 20px;
            min-height: 400px;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-subtitle {
            font-size: 0.85rem;
            color: #888;
        }
        .price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00d2ff;
        }
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status.waiting_payment { background: #f39c12; color: #000; }
        .status.funded { background: #3498db; color: #fff; }
        .status.shipped { background: #9b59b6; color: #fff; }
        .status.completed { background: #2ecc71; color: #000; }
        .status.disputed { background: #e74c3c; color: #fff; }
        .status.refunded { background: #95a5a6; color: #000; }
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,210,255,0.3);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        .btn-success {
            background: #2ecc71;
            color: #000;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #888;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }
        .modal-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .role-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .role-buyer { background: #3498db; }
        .role-seller { background: #9b59b6; }
        .system-controls {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .system-controls h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 12px;
        }
        .tick-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #2ecc71;
            color: #000;
            border-radius: 8px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
        }
        .toast.active {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.error {
            background: #e74c3c;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fiber Escrow Demo</h1>
            <div class="user-selector">
                <label>Acting as:</label>
                <select id="userSelect" onchange="switchUser()">
                    <option value="">Loading...</option>
                </select>
                <div class="balance" id="balance">0 shannons</div>
            </div>
        </header>

        <div class="tabs">
            <button id="tab-market" class="tab active" onclick="showTab('market')">Market</button>
            <button id="tab-orders" class="tab" onclick="showTab('orders')">My Orders</button>
            <button id="tab-arbiter" class="tab" onclick="showTab('arbiter')">Arbiter</button>
        </div>

        <!-- Market Tab -->
        <div id="market" class="tab-content active">
            <div id="productList"></div>
        </div>

        <!-- My Orders Tab -->
        <div id="orders" class="tab-content">
            <div id="orderList"></div>
        </div>

        <!-- Arbiter Tab -->
        <div id="arbiter" class="tab-content">
            <h3 style="margin-bottom: 16px;">Disputed Orders</h3>
            <div id="disputeList"></div>
            
            <div class="system-controls">
                <h3>Time Simulation (for testing auto-confirm)</h3>
                <div class="tick-controls">
                    <button class="btn btn-secondary" onclick="advanceTime(3600)">+1 hour</button>
                    <button class="btn btn-secondary" onclick="advanceTime(86400)">+1 day</button>
                    <button class="btn btn-secondary" onclick="advanceTime(86400 * 7)">+1 week</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dispute Modal -->
    <div id="disputeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">File Dispute</div>
            <div class="form-group">
                <label>Reason for dispute</label>
                <textarea id="disputeReason" placeholder="Describe the issue..."></textarea>
            </div>
            <div class="actions">
                <button class="btn btn-danger" onclick="submitDispute()">Submit Dispute</button>
                <button class="btn btn-secondary" onclick="closeDisputeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Purchase Confirmation Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">Confirm Purchase</div>
            <div id="purchaseDetails" style="margin-bottom: 16px;">
                <p><strong>Product:</strong> <span id="purchaseProductTitle"></span></p>
                <p><strong>Price:</strong> <span id="purchasePrice"></span> shannons</p>
            </div>
            <div id="purchaseInvoiceSection" style="display: none; margin-bottom: 16px;">
                <p style="color: #888; font-size: 0.85rem; margin-bottom: 8px;">Invoice created. Click "Confirm & Pay" to send payment from your Fiber node.</p>
                <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; word-break: break-all; font-size: 0.75rem; color: #aaa;">
                    <span id="purchaseInvoice"></span>
                </div>
            </div>
            <div id="purchaseLoading" style="display: none; text-align: center; padding: 20px; color: #888;">
                Creating invoice...
            </div>
            <div id="purchaseError" style="display: none; color: #e74c3c; margin-bottom: 12px;"></div>
            <div class="actions">
                <button id="purchaseConfirmBtn" class="btn btn-primary" onclick="confirmPurchase()" disabled>
                    Confirm & Pay
                </button>
                <button class="btn btn-secondary" onclick="closePurchaseModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        let currentUserId = null;
        let users = [];
        let disputeOrderId = null;
        // Purchase modal state
        let pendingPurchase = null; // {productId, productTitle, price, orderId, invoice, preimageHex}
        // Store preimages locally (in real app, would be in secure storage)
        let orderPreimages = {};

        // Crypto helpers for preimage/payment_hash generation
        async function generatePreimage() {
            // Generate 32 random bytes
            const preimage = new Uint8Array(32);
            crypto.getRandomValues(preimage);
            return preimage;
        }

        async function computePaymentHash(preimage) {
            // SHA-256 hash of preimage
            const hashBuffer = await crypto.subtle.digest('SHA-256', preimage);
            return new Uint8Array(hashBuffer);
        }

        function bytesToHex(bytes) {
            return '0x' + Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function hexToBytes(hex) {
            const cleanHex = hex.startsWith('0x') ? hex.slice(2) : hex;
            const bytes = new Uint8Array(cleanHex.length / 2);
            for (let i = 0; i < bytes.length; i++) {
                bytes[i] = parseInt(cleanHex.substr(i * 2, 2), 16);
            }
            return bytes;
        }

        // API helpers
        async function api(method, path, body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (currentUserId) {
                headers['X-User-Id'] = currentUserId;
            }
            const options = { method, headers };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const res = await fetch('/api' + path, options);
            return res.json();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast active' + (isError ? ' error' : '');
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // Tab navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-content#${tabId}`).classList.add('active');
            document.querySelectorAll('.tab')[['market', 'orders', 'arbiter'].indexOf(tabId)].classList.add('active');
            refresh();
        }

        // User management
        async function loadUsers() {
            const data = await api('GET', '/users');
            let rawUsers = data.users || [];
            
            // Sort users in order: buyer, seller, arbiter
            const order = ['buyer', 'seller', 'arbiter'];
            users = rawUsers.sort((a, b) => {
                let idxA = order.indexOf(a.username.toLowerCase());
                let idxB = order.indexOf(b.username.toLowerCase());
                if (idxA === -1) idxA = 99;
                if (idxB === -1) idxB = 99;
                return idxA - idxB;
            });

            const select = document.getElementById('userSelect');
            select.innerHTML = users.map(u => 
                `<option value="${u.id}">${u.username}</option>`
            ).join('');
            if (users.length > 0) {
                currentUserId = users[0].id;
                updateTabVisibility();
                updateBalance();
            }
        }

        async function switchUser() {
            currentUserId = document.getElementById('userSelect').value;
            updateTabVisibility();
            await updateBalance();
            refresh();
        }

        function updateTabVisibility() {
            const user = users.find(u => u.id === currentUserId);
            if (!user) return;

            const username = user.username.toLowerCase();
            const tabMarket = document.getElementById('tab-market');
            const tabOrders = document.getElementById('tab-orders');
            const tabArbiter = document.getElementById('tab-arbiter');
            const balanceElement = document.getElementById('balance');

            // Default: hide everything
            tabMarket.style.display = 'none';
            tabOrders.style.display = 'none';
            tabArbiter.style.display = 'none';
            balanceElement.style.display = 'block';

            if (username === 'arbiter') {
                tabArbiter.style.display = 'block';
                balanceElement.style.display = 'none';
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab !== 'arbiter') showTab('arbiter');
            } else if (username === 'seller') {
                tabOrders.style.display = 'block';
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab !== 'orders') showTab('orders');
            } else if (username === 'buyer') {
                tabMarket.style.display = 'block';
                tabOrders.style.display = 'block';
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'arbiter') showTab('market');
            }
        }

        async function updateBalance() {
            if (!currentUserId) return;
            const data = await api('GET', '/user/me');
            if (data.balance_shannons !== undefined) {
                document.getElementById('balance').textContent = `${data.balance_shannons.toLocaleString()} shannons`;
            }
        }

        // Products
        async function loadProducts() {
            const data = await api('GET', '/products');
            const list = document.getElementById('productList');
            const products = data.products || [];
            
            if (products.length === 0) {
                list.innerHTML = '<div class="empty-state">No products available.</div>';
                return;
            }

            list.innerHTML = products.map(p => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${escapeHtml(p.title)}</div>
                            <div class="card-subtitle">by ${escapeHtml(p.seller_username || 'Unknown')}</div>
                        </div>
                        <div class="price">${p.price_shannons.toLocaleString()} shannons</div>
                    </div>
                    <p style="color: #aaa; font-size: 0.9rem;">${escapeHtml(p.description)}</p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="buyProduct('${p.id}')" 
                            ${p.seller_id === currentUserId ? 'disabled title="Your own product"' : ''}>
                            Buy Now
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function buyProduct(productId) {
            // Get product info for display
            const productsData = await api('GET', '/products');
            const product = (productsData.products || []).find(p => p.id === productId);
            if (!product) {
                showToast('Product not found', true);
                return;
            }

            // Show modal with loading state
            document.getElementById('purchaseProductTitle').textContent = product.title;
            document.getElementById('purchasePrice').textContent = product.price_shannons.toLocaleString();
            document.getElementById('purchaseInvoiceSection').style.display = 'none';
            document.getElementById('purchaseLoading').style.display = 'block';
            document.getElementById('purchaseError').style.display = 'none';
            document.getElementById('purchaseConfirmBtn').disabled = true;
            document.getElementById('purchaseModal').classList.add('active');

            // Generate preimage and create order
            const preimage = await generatePreimage();
            const preimageHex = bytesToHex(preimage);

            const data = await api('POST', '/orders', { 
                product_id: productId,
                preimage: preimageHex
            });

            document.getElementById('purchaseLoading').style.display = 'none';

            if (data.order_id) {
                // Store preimage locally
                orderPreimages[data.order_id] = preimageHex;
                localStorage.setItem(`preimage_${data.order_id}`, preimageHex);

                // Store pending purchase info
                pendingPurchase = {
                    productId: productId,
                    productTitle: product.title,
                    price: product.price_sat,
                    orderId: data.order_id,
                    invoice: data.invoice_string,
                    preimageHex: preimageHex
                };

                // Show invoice
                if (data.invoice_string) {
                    document.getElementById('purchaseInvoice').textContent = data.invoice_string;
                    document.getElementById('purchaseInvoiceSection').style.display = 'block';
                    document.getElementById('purchaseConfirmBtn').disabled = false;
                } else {
                    // No Fiber configured on server, show mock mode message
                    document.getElementById('purchaseError').textContent = 'Server not connected to Fiber. Order created in mock mode.';
                    document.getElementById('purchaseError').style.display = 'block';
                    closePurchaseModal();
                    showToast('Order created (mock mode). Go to My Orders.');
                    refresh();
                }
            } else {
                document.getElementById('purchaseError').textContent = data.error || 'Failed to create order';
                document.getElementById('purchaseError').style.display = 'block';
            }
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.remove('active');
            pendingPurchase = null;
        }

        async function confirmPurchase() {
            if (!pendingPurchase || !pendingPurchase.invoice) {
                showToast('No pending purchase', true);
                return;
            }

            // Disable button and show loading
            document.getElementById('purchaseConfirmBtn').disabled = true;
            document.getElementById('purchaseConfirmBtn').textContent = 'Sending payment...';

            try {
                // Call buyer's Fiber node via backend proxy (backend has buyer RPC URL configured)
                const paymentResult = await sendPaymentViaProxy(pendingPurchase.invoice);
                console.log('Payment result:', paymentResult);

                const status = (paymentResult.status || 'unknown').toLowerCase();
                if (status === 'success' || status === 'inflight' || status === 'created') {
                    document.getElementById('purchaseConfirmBtn').textContent = 'Verifying payment...';
                    
                    // Wait a moment for payment to propagate
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Notify escrow to verify payment
                    const verifyData = await api('POST', `/orders/${pendingPurchase.orderId}/pay`);
                    
                    closePurchaseModal();
                    
                    if (verifyData.status === 'funded') {
                        showToast('Payment confirmed! Waiting for seller to ship.');
                    } else {
                        showToast('Payment sent! Verification pending.');
                    }
                    refresh();
                } else {
                    // Show more detailed error info
                    const error = paymentResult.failed_error || paymentResult.error || `Unknown status: ${status}`;
                    console.error('Payment failed:', paymentResult);
                    document.getElementById('purchaseError').textContent = `Payment failed: ${error}`;
                    document.getElementById('purchaseError').style.display = 'block';
                    document.getElementById('purchaseConfirmBtn').disabled = false;
                    document.getElementById('purchaseConfirmBtn').textContent = 'Confirm & Pay';
                }
            } catch (e) {
                document.getElementById('purchaseError').textContent = `Payment error: ${e.message}`;
                document.getElementById('purchaseError').style.display = 'block';
                document.getElementById('purchaseConfirmBtn').disabled = false;
                document.getElementById('purchaseConfirmBtn').textContent = 'Confirm & Pay';
            }
        }

        // Orders
        async function loadOrders() {
            const data = await api('GET', '/orders/mine');
            const list = document.getElementById('orderList');
            const orders = data.orders || [];
            
            if (orders.length === 0) {
                list.innerHTML = '<div class="empty-state">No orders yet. Browse the Market to buy something!</div>';
                return;
            }

            list.innerHTML = orders.map(o => {
                const isBuyer = o.buyer_id === currentUserId;
                const isSeller = o.seller_id === currentUserId;
                return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">
                                ${escapeHtml(o.product_title)}
                                <span class="role-badge ${isBuyer ? 'role-buyer' : 'role-seller'}">
                                    ${isBuyer ? 'Buyer' : 'Seller'}
                                </span>
                            </div>
                            <div class="card-subtitle">Order #${o.id.slice(0, 8)}</div>
                        </div>
                        <div>
                            <span class="status ${o.status}">${formatStatus(o.status)}</span>
                            <div class="price" style="margin-top: 4px;">${o.amount_shannons.toLocaleString()} shannons</div>
                        </div>
                    </div>
                    ${o.invoice_string ? `<p style="color: #888; font-size: 0.75rem; word-break: break-all; margin-bottom: 8px;">Invoice: ${escapeHtml(o.invoice_string.slice(0, 50))}...</p>` : ''}
                    ${o.dispute ? `<p style="color: #e74c3c; font-size: 0.9rem;">Dispute: ${escapeHtml(o.dispute.reason)}</p>` : ''}
                    <div class="actions">
                        ${getOrderActions(o, isBuyer, isSeller)}
                    </div>
                </div>
            `}).join('');
        }

        function formatStatus(status) {
            return status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function getOrderActions(order, isBuyer, isSeller) {
            const actions = [];
            
            if (isBuyer && order.status === 'waiting_payment') {
                actions.push(`<button class="btn btn-primary" onclick="payOrder('${order.id}')">Pay Now</button>`);
            }
            if (isSeller && order.status === 'funded') {
                actions.push(`<button class="btn btn-primary" onclick="shipOrder('${order.id}')">Mark Shipped</button>`);
            }
            if (isBuyer && order.status === 'shipped') {
                actions.push(`<button class="btn btn-success" onclick="confirmOrder('${order.id}')">Confirm Receipt</button>`);
                actions.push(`<button class="btn btn-danger" onclick="openDisputeModal('${order.id}')">Dispute</button>`);
            }
            if (isBuyer && order.status === 'funded') {
                actions.push(`<button class="btn btn-danger" onclick="openDisputeModal('${order.id}')">Dispute</button>`);
            }
            
            return actions.join('');
        }

        async function payOrder(orderId) {
            // First, get the order details to get the invoice
            const orderData = await api('GET', `/orders/${orderId}`);
            // API returns order fields directly (not wrapped in {order: ...})
            if (!orderData.invoice_string) {
                showToast('Order not found or no invoice available', true);
                return;
            }

            const invoice = orderData.invoice_string;
            showToast('Sending payment via your Fiber node...');

            try {
                // Call buyer's Fiber node via backend proxy (backend has buyer RPC URL configured)
                const paymentResult = await sendPaymentViaProxy(invoice);
                console.log('=== Payment Result ===');
                console.log('Full result:', JSON.stringify(paymentResult, null, 2));
                console.log('Status:', paymentResult.status);
                console.log('Payment hash:', paymentResult.payment_hash);
                console.log('Failed error:', paymentResult.failed_error);

                // Check payment status (Fiber returns PascalCase: Created, Inflight, Success)
                const status = (paymentResult.status || 'unknown').toLowerCase();
                if (status === 'success' || status === 'inflight' || status === 'created') {
                    showToast('Payment sent! Verifying with escrow...');
                    
                    // Give the payment a moment to propagate, then verify with escrow
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Notify escrow to check payment status
                    const verifyData = await api('POST', `/orders/${orderId}/pay`);
                    if (verifyData.status === 'funded') {
                        showToast('Payment confirmed! Waiting for seller to ship.');
                        refresh();
                    } else {
                        showToast('Payment sent but not yet confirmed. Try refreshing in a moment.', true);
                        refresh();
                    }
                } else {
                    const error = paymentResult.failed_error || paymentResult.error || `Unknown status: ${status}`;
                    console.error('Payment failed:', paymentResult);
                    showToast(`Payment failed: ${error}`, true);
                }
            } catch (e) {
                showToast(`Payment error: ${e.message}`, true);
            }
        }

        // Fiber RPC helper (uses backend proxy which has buyer RPC URL configured)
        async function sendPaymentViaProxy(invoice) {
            const response = await fetch('/api/fiber/send_payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ invoice: invoice })
            });

            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            return result;
        }

        async function shipOrder(orderId) {
            const data = await api('POST', `/orders/${orderId}/ship`);
            if (data.status === 'shipped') {
                showToast('Marked as shipped! Waiting for buyer confirmation.');
                refresh();
            } else {
                showToast(data.error || 'Failed to ship', true);
            }
        }

        async function confirmOrder(orderId) {
            // Preimage is already stored in escrow, just confirm receipt
            const data = await api('POST', `/orders/${orderId}/confirm`, {});
            if (data.status === 'completed') {
                // Clean up local preimage storage
                delete orderPreimages[orderId];
                localStorage.removeItem(`preimage_${orderId}`);
                
                showToast('Order completed! Funds released to seller.');
                refresh();
            } else {
                showToast(data.error || 'Failed to confirm', true);
            }
        }

        // Disputes
        function openDisputeModal(orderId) {
            disputeOrderId = orderId;
            document.getElementById('disputeModal').classList.add('active');
        }

        function closeDisputeModal() {
            disputeOrderId = null;
            document.getElementById('disputeReason').value = '';
            document.getElementById('disputeModal').classList.remove('active');
        }

        async function submitDispute() {
            const reason = document.getElementById('disputeReason').value.trim();
            if (!reason) {
                showToast('Please provide a reason', true);
                return;
            }
            const data = await api('POST', `/orders/${disputeOrderId}/dispute`, { reason });
            if (data.status === 'disputed') {
                showToast('Dispute filed successfully');
                closeDisputeModal();
                refresh();
            } else {
                showToast(data.error || 'Failed to file dispute', true);
            }
        }

        async function loadDisputes() {
            const data = await api('GET', '/arbiter/disputes');
            const list = document.getElementById('disputeList');
            const disputes = data.disputes || [];
            
            if (disputes.length === 0) {
                list.innerHTML = '<div class="empty-state">No disputes to resolve.</div>';
                return;
            }

            list.innerHTML = disputes.map(o => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${escapeHtml(o.product_title)}</div>
                            <div class="card-subtitle">Order #${o.id.slice(0, 8)}</div>
                        </div>
                        <div class="price">${o.amount_shannons.toLocaleString()} shannons</div>
                    </div>
                    <p style="color: #e74c3c; margin: 8px 0; font-size: 0.9rem;">
                        <strong>Dispute reason:</strong> ${escapeHtml(o.dispute?.reason || 'N/A')}
                    </p>
                    <div class="actions">
                        <button class="btn btn-success" onclick="resolveDispute('${o.id}', 'seller')">
                            Release to Seller
                        </button>
                        <button class="btn btn-danger" onclick="resolveDispute('${o.id}', 'buyer')">
                            Refund Buyer
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function resolveDispute(orderId, resolution) {
            const data = await api('POST', `/arbiter/disputes/${orderId}/resolve`, { resolution });
            if (data.status === 'resolved') {
                showToast(`Dispute resolved in favor of ${resolution}`);
                refresh();
            } else {
                showToast(data.error || 'Failed to resolve', true);
            }
        }

        // Time simulation
        async function advanceTime(seconds) {
            const data = await api('POST', '/system/tick', { seconds });
            const expired = data.expired_orders || [];
            if (expired.length > 0) {
                showToast(`${expired.length} order(s) auto-confirmed!`);
            } else {
                showToast(`Time advanced by ${seconds} seconds`);
            }
            refresh();
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refresh() {
            updateBalance();
            const activeTab = document.querySelector('.tab-content.active').id;
            if (activeTab === 'market') loadProducts();
            else if (activeTab === 'orders') loadOrders();
            else if (activeTab === 'arbiter') loadDisputes();
        }

        // Initialize
        // Load stored preimages from localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('preimage_')) {
                const orderId = key.replace('preimage_', '');
                orderPreimages[orderId] = localStorage.getItem(key);
            }
        }
        loadUsers().then(() => refresh());
    </script>
</body>
</html>
